<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>THDX â€¢ LZ Receiver v1.4.2 (Auto Source EID + Payload)</title>

  <script>
    (function loadEthers(){
      const s=document.createElement("script");
      s.src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js";
      s.onload=()=>console.log("âœ… ethers.js loaded");
      s.onerror=()=>alert("âš ï¸ Gagal memuat ethers.js, coba refresh halaman.");
      document.head.appendChild(s);
    })();
  </script>

  <style>
    body{font-family:system-ui,Arial;background:#0b1220;color:#fff;margin:0;min-height:100vh;display:grid;place-items:center}
    .card{width:min(560px,94vw);background:#121a2a;border:1px solid #22304a;border-radius:12px;padding:22px;box-shadow:0 10px 28px rgba(0,0,0,.45)}
    h1{margin:4px 0 12px;color:#7c5cff;text-align:center}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #22304a;background:#0f1625;color:#fff;font-size:14px;margin-top:8px}
    button{width:100%;padding:12px;border:0;border-radius:10px;margin-top:10px;font-weight:700;font-size:15px;cursor:pointer}
    .primary{background:linear-gradient(90deg,#6ee7ff,#7c5cff);color:#04131a}
    .ok{background:linear-gradient(90deg,#22c55e,#16a34a);color:#fff}
    .muted{background:#24324d;color:#9fb0d9}
    pre{background:#0f1625;border:1px solid #22304a;border-radius:10px;padding:10px;white-space:pre-wrap;max-height:240px;overflow:auto;margin-top:12px;font-size:12.5px}
    small{color:#9fb0d9}
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸŒ THDX â€¢ LZ Receiver v1.4.2</h1>
    <div class="row">
      <button id="connect" class="primary">ğŸ”Œ Connect Wallet</button>
      <button id="switchNet" class="muted">ğŸ” Switch Network</button>
    </div>

    <input id="contract" value="0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90" placeholder="OApp Stable Contract" />
    <div class="row">
      <input id="srcEid" placeholder="srcEid (auto)" readonly />
      <input id="executor" placeholder="executor (auto)" readonly />
    </div>

    <input id="txHash" placeholder="TX hash (Sepolia, optional)" />
    <textarea id="payload" rows="3" placeholder="Payload hex (auto / manual)"></textarea>
    <textarea id="options" rows="2" placeholder="Options" readonly>0x</textarea>

    <div class="row">
      <button id="fetch" class="muted">ğŸ“¥ Fetch Payload</button>
      <button id="auto" class="muted">âš¡ Auto Fill Payload</button>
    </div>

    <div class="row">
      <button id="send" class="ok">ğŸš€ Run lzReceive()</button>
      <button id="openTx" class="muted">ğŸ”— Open TX</button>
    </div>

    <pre id="log">log siap...</pre>
  </div>

  <script>
  async function waitForEthers(){
    while(typeof window.ethers==="undefined"){await new Promise(r=>setTimeout(r,150));}
  }

  document.addEventListener("DOMContentLoaded",async()=>{
    await waitForEthers();
    const $=id=>document.getElementById(id);
    const log=m=>{const el=$("log");el.textContent+=(el.textContent?"\n":"")+m;el.scrollTop=el.scrollHeight;console.log(m);};
    let provider,signer,me,currentChainId,lastTx;

    const CHAINS={
      11155111:{name:"Sepolia",lzEid:30101,explorer:"https://sepolia.etherscan.io"},
      2201:{name:"Stable",lzEid:40374,explorer:"https://blockscout.testnet.stable.xyz"}
    };

    function autoFill(chain){
      if(chain===2201){
        $("srcEid").value="30101"; // Source = Sepolia
        $("executor").value="0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90";
        $("options").value="0x";
        log("ğŸŒ Detected Stable Testnet â†’ srcEid=30101 (Sepolia)");
      }else{
        $("srcEid").value="40374";
        $("executor").value="0x0000000000000000000000000000000000000000";
        log("ğŸŒ Detected Sepolia â†’ dstEid=40374 (Stable)");
      }
    }

    async function connect(){
      try{
        if(!window.ethereum)throw new Error("Wallet tidak tersedia.");
        provider=new ethers.providers.Web3Provider(window.ethereum,"any");
        await provider.send("eth_requestAccounts",[]);
        signer=provider.getSigner();
        me=await signer.getAddress();
        const net=await provider.getNetwork();
        currentChainId=Number(net.chainId);
        $("connect").textContent="âœ… Connected";
        log(`âœ… Connected: ${me}\nChain: ${currentChainId}`);
        autoFill(currentChainId);
      }catch(e){log("âŒ Connect error: "+(e.message||e));}
    }

    async function switchNet(){
      const target=currentChainId===2201?11155111:2201;
      await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:ethers.utils.hexValue(target)}]});
      const net=await provider.getNetwork();
      currentChainId=Number(net.chainId);
      autoFill(currentChainId);
      log(`ğŸ” Switched to ${CHAINS[currentChainId].name}`);
    }

    // Auto payload generator (default 10 USDC)
    async function autoPayload(){
      if(!me)return log("âš ï¸ Connect wallet dulu");
      const addr="0x"+me.slice(2).padStart(64,"0");
      const amt=ethers.utils.hexZeroPad(ethers.BigNumber.from("10000000").toHexString(),32); // 10 USDC
      const payload=addr+amt.slice(2);
      $("payload").value=payload;
      log("âš¡ Auto payload generated (10 USDC): "+payload);
    }

    async function runLzReceive(){
      try{
        const oapp=$("contract").value.trim();
        const srcEid=Number($("srcEid").value);
        const exec=$("executor").value.trim();
        const payload=$("payload").value.trim();
        if(!oapp||!payload)return log("âš ï¸ Lengkapi semua field");
        const sender="0x"+me.slice(2).padStart(64,"0");
        const LZ_ABI=["function lzReceive(uint32,bytes32,bytes,address,bytes) external payable"];
        const c=new ethers.Contract(oapp,LZ_ABI,signer);
        log(`ğŸš€ Sending lzReceive()...`);
        const tx=await c.lzReceive(srcEid,sender,payload,exec,"0x");
        log(`â³ TX: ${tx.hash}`);
        const rc=await tx.wait();
        log(`âœ… Success! Block ${rc.blockNumber}`);
        lastTx=tx.hash;
      }catch(e){log("âŒ Error: "+(e.message||e));}
    }

    $("connect").onclick=connect;
    $("switchNet").onclick=switchNet;
    $("auto").onclick=autoPayload;
    $("send").onclick=runLzReceive;
    $("openTx").onclick=()=>{if(!lastTx)return;window.open(`${CHAINS[currentChainId].explorer}/tx/${lastTx}`,"_blank");};
  });
  </script>
</body>
</html>
